<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../../bower_components/moment/moment.js"></script>
<script src="../../bower_components/moment-recur/moment-recur.js"></script>
<dom-module id="create-time">
  <style>
    :host {
      display: block;
    }

    paper-button {
      margin-bottom: 24px;
      width: 15%;
    }

    paper-material {
      padding-bottom: 10px;
      padding-top: 10px;
    }

    paper-item-body.paper-item-body-1 {
      width: 50%;
    }

    paper-item-body.paper-item-body-0 [secondary] {
      color: #757575;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
      ;
    }

    .paper-date-picker-dialog {
      max-height: 550px !important;
    }

    .spacer {
      padding-top: 10px;
      border-bottom: 1px solid gray;
    }

    label.prev {
      padding-left: 20px;
      color: #727272;
      position: relative;
      top: 10px;
    }

    #button {
      padding-bottom: 20px;
      width: 100%
    }

    #startDialog,
    #endDialog,
    #startTimeDialog,
    #endTimeDialog {
      max-width: 540px;
    }

    #docentbutton {
      display: block;
      position: relative;
      /*width: 100%;*/
    }

    #docentbutton paper-item-body {
      margin: 0 auto;
      width: 70%;
    }

    .docent {
      text-align: center;
    }

    #checkboxes {
      width: 100%;
      text-align: center;
    }

    paper-checkbox {
      padding-left: 2%;
    }
  </style>
  <template>

    <paper-material elevation="1">




      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click=''>
          <h4>Pick the days:</h4>
          <div class="checkboxes">

            <paper-checkbox name="monday" checked="{{checkedMonday}}" id="monday">Monday</paper-checkbox>
            <paper-checkbox name="tuesday" checked="{{checkedTuesday}}" id="tuesday">Tuesday</paper-checkbox>
            <paper-checkbox name="wednesday" checked="{{checkedWednesday}}" id="wednesday">Wednesday</paper-checkbox>
            <paper-checkbox name="thursday" checked="{{checkedThursday}}" id="thursday">Thursday</paper-checkbox>
            <paper-checkbox name="friday" checked="{{checkedFriday}}" id="friday">Friday</paper-checkbox>
            <paper-checkbox name="saturday" checked="{{checkedSaturday}}" id="saturday">Saturday</paper-checkbox>
          </div>


        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" flat>
          <paper-dropdown-menu label="Select a docent">
            <paper-menu id="dropdown" selected="{{selDocent}}" attr-for-selected="docent" class="dropdown-content">
              <template is="dom-repeat" items="{{docentList}}" as="docent">
                <paper-item docent="{{docent.object}}">
                  <span class="docentItem">{{docent.fullName}}</span>
                </paper-item>
              </template>
            </paper-menu>
          </paper-dropdown-menu>
        </paper-item-body>

      </paper-item>

      <!-- <paper-item>
        <paper-item-body class="paper-item-body-0" flat>
<span>[[selDocent]]</span>
        </paper-item-body>

      </paper-item> -->

      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartClick'>
          <h4>Start Date:</h4>
          <p>
            <span>{{startDate}}</span>
          </p>

        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndClick'>
          <h4>End Date:</h4>
          <p>
            <span>{{endDate}}</span>
          </p>


        </paper-item-body>


      </paper-item>
      </hr>
      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartTimeClick'>
          <h4>Start Time:</h4>
          <p>
            <span>{{startTime}}</span>
          </p>

        </paper-item-body>

      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndTimeClick'>
          <h4>End Time:</h4>
          <p>
            <span>{{endTime}}</span>
          </p>

        </paper-item-body>

      </paper-item>




    </paper-material>

    <paper-material elevation="1">
      <paper-item>

        <paper-item-body class="paper-item-body-1">

          <paper-input-container>
            <label>Slot Duration</label>
            <input is="iron-input" name="duration" type="number" value="{{duration::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-1">
          <paper-input-container>
            <label>Break Duration</label>
            <input is="iron-input" name="break" type="number" value="{{break::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>


      <div id="button">
        <div id="button-create">
          <paper-button id='setTime' raised on-click='createSlots'>Create Time Slots</paper-button>
        </div>
      </div>


    </paper-material>

    <paper-dialog id="startDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateStartPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setStart">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="endDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateEndPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setEnd">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="startTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-time-picker id="timeStartPicker"></paper-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setStartTime">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="endTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">

      <paper-time-picker id="timeEndPicker"></paper-time-picker>


      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setEndTime"> OK</paper-button>

      </div>

    </paper-dialog>
    <paper-dialog id="editDocentDialog" modal role="dialog" exit-animation="fade-out-animation">
      <template is="dom-repeat" items="{{docentList}}">
        <div id="docentbutton" on-click="pickDocent" dialog-confirm>


          <paper-item-body class="paper-item-body-0">

            <!-- <paper-button flat dialog-confirm > -->
            <p class="docent">
              <paper-ripple fit></paper-ripple>
              <!-- <paper-ripple fit></paper-ripple> -->
              <span>{{item.firstName}}</span>
              <span>{{item.lastName}}</span>
            </p>
            <!-- </paper-button> -->

          </paper-item-body>

          </paper-item>
        </div>

      </template>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>

      </div>
    </paper-dialog>
    <paper-dialog id="warningDialog" modal>

      <paper-header-panel>
        <paper-toolbar>
          <div>
            <h2>{{errorType}}</h2>
          </div>
        </paper-toolbar>
      </paper-header-panel>

      <paper-item>

        <div>
          <span>{{errorMessage}}</span>
        </div>


      </paper-item>


      <div class="buttons">
        <paper-button flat dialog-dismiss>OK</paper-button>
      </div>
    </paper-dialog>
  </template>


  <script>
    (function() {

      Polymer({
        is: 'create-time',
        properties: {
          selDocent:{
            Type: Object,
            notify:true
          },
          errorType: {
            Type: String,
            notify: true
          },
          errorMessage: {
            Type: String,
            notify: true
          },
          errorEvent: {
            Type: String,
            notify: true
          },
          checkedMonday: {
            type: Boolean,
            observer: '_mondayChanged'
          },
          checkedTuesday: {
            type: Boolean,
            observer: '_tuesdayChanged'
          },
          checkedWednesday: {
            type: Boolean,
            observer: '_wednesdayChanged'
          },
          checkedThursday: {
            type: Boolean,
            observer: '_thursdayChanged'
          },
          checkedFriday: {
            type: Boolean,
            observer: '_fridayChanged'
          },
          checkedSaturday: {
            type: Boolean,
            observer: '_saturdayChanged'
          },
          docentList: {
            type: Array,
          },
          startDate: {
            Type: Date,
            notify: true
          },
          endDate: {
            Type: Date,
            notify: true
          },
          startTime: {
            Type: Number,
            notify: true
          },
          endTime: {
            Type: Number,
            notify: true
          },
          docentname: {
            type: String,
            notify: true
          },
          selectedDocent: {
            type: Object
          },
          break: {
            type: Number,
            notify: true,
            value: 5
          },
          duration: {
            type: Number,
            notify: true,
            value: 10
          }


        },

        _mondayChanged: function(newValue, oldValue) {
          this.mondayChecked = !this.mondayChecked;
          console.log("changed", this.mondayChecked);
        },
        _tuesdayChanged: function(newValue, oldValue) {
          this.tuesdayChecked = !this.tuesdayChecked;

        },
        _wednesdayChanged: function(newValue, oldValue) {
          this.wednesdayChecked = !this.wednesdayChecked;
          console.log("changed", this.wednesdayChecked);
        },
        _thursdayChanged: function(newValue, oldValue) {
          this.thursdayChecked = !this.thursdayChecked;
        },
        _fridayChanged: function(newValue, oldValue) {
          this.fridayChecked = !this.fridayChecked;
        },
        _saturdayChanged: function(newValue, oldValue) {
          this.saturdayChecked = !this.saturdayChecked;
        },
        ready: function() {

          var self = this;
          var startWeekday, origEndTime, origStartTime;
          var DocentQuery = Parse.Object.extend("Docent");
          var query = new Parse.Query(DocentQuery);
          var clicker;
          var List = [];
          var email;
            var allDocent = {};
            allDocent['fullName'] = "All Docents";
            allDocent['status'] = "all";
            allDocent['object'] = {};
             List.push(allDocent);
            query.find().then(function(results) {

            for (i in results) {
              var docent = {};
              var object = results[i];
              var docentName = object.get("lastName") + " " + object.get('firstName');
              docent['firstName'] = object.get('firstName');
              docent['lastName'] = object.get('lastName');
              docent['email'] = object.get('email');
              docent['fullName'] = docentName;
              docent['object'] = object;
              List.push(docent);
              // console.log(docentName);
            }

            self.docentList = List;
            console.log("liste", self.docentList);
          });


        },
        editButton: function(e) {

          clicker = e.model;
          this.$.editDocentDialog.toggle();

        },

        handleStartClick: function() {
          this.$.startDialog.toggle();
        },
        handleEndClick: function() {
          this.$.endDialog.toggle();
        },
        handleStartTimeClick: function() {
          this.$.startTimeDialog.toggle();
        },
        handleEndTimeClick: function() {
          this.$.endTimeDialog.toggle();
        },
        setStart: function(e) {
          if (this.$.dateStartPicker.date != undefined) {
            var date = this.$.dateStartPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          startWeekday = date.substring(0, 4);
          console.log(startWeekday);
          var formattedDate = date.substring(4, date.length);
          this.startDate = formattedDate;

        },
        setEnd: function() {
          if (this.$.dateEndPicker.date != undefined) {
            var date = this.$.dateEndPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          var formattedDate = date.substring(4, date.length);
          this.endDate = formattedDate;

        },

        setStartTime: function() {

          origStartTime = this.$.timeStartPicker.time;
          var all = origStartTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origStartTime.substring(origStartTime.length - 2, origStartTime.length);
          if (getAMPM === "PM") {
            var hours = hours + 12;
            if (hours === 24) {
              hours = 0;
            }
            }else if(getAMPM === "AM") {
              if(hours === 12){
                hours = 0;
              }
            }
          this.startTime = hours + ":" + minutes;

        },
        setEndTime: function() {
          origEndTime = this.$.timeEndPicker.time;
          var all = origEndTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origEndTime.substring(origEndTime.length - 2, origEndTime.length);
          if (getAMPM === "PM") {
            var hours = hours + 12;
            if (hours === 24) {
              hours = 0;
            }
            }else if(getAMPM === "AM") {
              if(hours === 12){
                hours = 0;
              }
            }

          this.endTime = hours + ":" + minutes;
        },

        createSlots: function(e) {
          var selected = this.selDocent;
          console.log(selected);
          var startDate = moment(new Date(this.startDate));
          var endDate = moment(new Date(this.endDate));

          var startTime = this.startTime;
          var endTime = this.endTime;

          var breakTime = this.break;
          var duration = this.duration;
          var partTime = breakTime * 1 + duration * 1;
          var allStart = startTime.split(":");
          var allEnd = endTime.split(":");
          var hoursStart = parseInt(allStart[0]);
          var minutesStart = allStart[1].substring(0, allStart[1].length - 2);
          var hoursEnd = parseInt(allEnd[0]);
          var minutesEnd = allEnd[1].substring(0, allEnd[1].length - 2);
          console.log(startDate, endDate);


          if (hoursStart >= hoursEnd) {
            if (hoursStart === hoursEnd) {
              if (minutesStart >= minutesEnd) {
                this.errorType ="Times are set incorrectly"
                this.errorMessage = "Please check the time settings";
                this.$.warningDialog.toggle();
                return;
              }
            }
            if (hoursStart > hoursEnd) {
              this.errorType ="Times are set incorretly"
              this.errorMessage = "Please check the time settings";
              this.$.warningDialog.toggle();
              return;
            }
          }

          //   var timeDiffer = (60 * hoursEnd + minutesEnd * 1) - (60 * hoursStart + minutesStart * 1);
          // // console.log("times",hoursEnd,minutesEnd,hoursStart,minutesEnd);
          //   // console.log("differ",timeDiffer);
          //   var timeArray = new Array(parseInt(timeDiffer / partTime));
          // if (partTime > timeDiffer) {
          //   alert("Bitte Zeitslots anpassen");
          //   return;
          // }
          //
          // for (var i = 0; i < timeArray.length; i++) {
            // timeArray[i] = {
            //   startTime: start.toString(),
            //   endTime: (start.add(t1)).toString(),
            //   availability: "true"
            // }
          //
          //   start = start.add(part);
          // }


          if (startDate.isBefore(endDate)) {

            var monday = !this.mondayChecked;
            var tuesday = !this.tuesdayChecked;
            var wednesday = !this.wednesdayChecked;
            var thursday = !this.thursdayChecked;
            var friday = !this.fridayChecked;
            var saturday = !this.saturdayChecked;

            var endWeekday;
            var selected = [];
            if (monday) {
              endWeekday = 1;
              selected.push(endWeekday);
            }
            if (tuesday) {
              endWeekday = 2;
              selected.push(endWeekday);
            }
            if (wednesday) {
              endWeekday = 3;
              selected.push(endWeekday);
            }
            if (thursday) {
              endWeekday = 4;
              selected.push(endWeekday);
            }
            if (friday) {
              friday = 5;
              selected.push(endWeekday);
            }
            if (saturday) {
              endWeekday = 6;
              selected.push(endWeekday);
            }

            if (startDate.diff(endDate, 'days') * -1 >= 366) {

              this.errorType = "Dates are set incorretly"
              this.errorMessage = "The time span is longer than one year";
              this.$.warningDialog.toggle();
            } else {

              var myDate = startDate;
              var recurrence = myDate.recur().every(selected).daysOfWeek();
              recurrence.startDate(startDate);
              recurrence.endDate(endDate);
              var allDates = recurrence.all("L");
              // console.log("allDates", allDates);

              for (i in allDates) {

                var day = allDates[i];
                var dayString = day.substring(0, 2);
                var monthString = day.substring(3, 6);
                var yearString = day.substring(6, day.length);
                console.log("year", yearString);
                var fixedStartDate = new moment();
                fixedStartDate.set('year', yearString);
                fixedStartDate.set('month', monthString);
                fixedStartDate.set('date', dayString);
                fixedStartDate.set('hour', hoursStart);
                fixedStartDate.set('minute', minutesStart);

                var fixedEndDate = new moment();
                fixedEndDate.set('year', yearString);
                fixedEndDate.set('month', monthString);
                fixedEndDate.set('date', dayString);
                fixedEndDate.set('hour', hoursEnd);
                fixedEndDate.set('minute', minutesEnd);

                var timeSpan = fixedStartDate.diff(fixedEndDate,"minute")*-1;
                var sT = fixedStartDate;
                var timeArray= [];
                while(sT.diff(fixedEndDate,"minute")*-1 >= 0+duration+breakTime){
                  var slot ={};
                  var slotStart = sT.clone();
                  var slotEnd = slotStart.clone().add(duration,"minutes");
                  slot['startTime'] = moment(slotStart).locale('en', {
                    months: [
                      "January", "February", "March", "April", "May", "June", "July",
                      "August", "September", "October", "November", "December"
                    ]
                  }).format("HH:mm");
                  slot['endTime'] = moment(slotEnd).locale('en', {
                    months: [
                      "January", "February", "March", "April", "May", "June", "July",
                      "August", "September", "October", "November", "December"
                    ]
                  }).format("HH:mm");
;

                  slot['availability'] = true;
                  timeArray.push(slot);
                  sT.add(duration,"minutes").add(breakTime,"minutes");

                }

                  console.log("sel",this.selDocent);
                  console.log("start",fixedStartDate);

                  var Slots = Parse.Object.extend("Slots");
                   var slotQuery = new Slots();
                  //  slotQuery.include("Docent");
                   slotQuery.set("Docent", this.selDocent);
                   slotQuery.set("date", fixedStartDate);

                   slotQuery.set("Slots", timeArray);
                  //  console.log("warum=", timeArray[i]);
                   slotQuery.save();
                 }
               }
          } else {
            this.errorType = "Dates are set incorretly"
            this.errorMessage = "The Start Date needs to be before the End Date";
            this.$.warningDialog.toggle();
          }

        }
      });
    })();
  </script>
</dom-module>
