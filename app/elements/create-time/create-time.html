<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../../bower_components/moment/moment.js"></script>
<dom-module id="create-time">
  <style>
    :host {
      display: block;
    }

    paper-button {
      margin-bottom: 24px;
      width: 15%;
    }

    paper-material {
      padding-bottom: 10px;
      padding-top: 10px;
    }

    paper-item-body.paper-item-body-1 {
      width: 50%;
    }

    paper-item-body.paper-item-body-0 [secondary] {
      color: #757575;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
      ;
    }

    .spacer {
      padding-top: 10px;
      border-bottom: 1px solid gray;
    }

    label.prev {
      padding-left: 20px;
      color: #727272;
      position: relative;
      top: 10px;
    }

    #button {
      padding-bottom: 20px;
      width: 100%
    }
    /*paper-button {
      width: 30%;
      display: block;
      margin-top: 30px;
      margin-left: auto;
      margin-right: auto;
    }*/

    #checkboxes {
      width: 100%;
      text-align: center;
    }

    paper-checkbox {
      padding-left: 2%;
    }
  </style>
  <template>

    <paper-material elevation="1">




      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click=''>
          <h4>Pick the days:</h4>
          <div class="checkboxes">

            <paper-checkbox name="monday" checked="{{checkedMonday}}" id="monday">Monday</paper-checkbox>
            <paper-checkbox name="tuesday" checked="{{checkedTuesday}}" id="tuesday">Tuesday</paper-checkbox>
            <paper-checkbox name="wednesday" checked="{{checkedWednesday}}" id="wednesday">Wednesday</paper-checkbox>
            <paper-checkbox name="thursday" checked="{{checkedThursday}}" id="thursday">Thursday</paper-checkbox>
            <paper-checkbox name="friday" checked="{{checkedFriday}}" id="friday">Friday</paper-checkbox>
            <paper-checkbox name="saturday" checked="{{checkedSaturday}}" id="saturday">Saturday</paper-checkbox>
          </div>


        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" flat on-click="editButton">

          <h4>Choose Docent: </h4>
          <p>
            <span>{{docentname}}</span>
          </p>
        </paper-item-body>

      </paper-item>




      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartClick'>
          <h4>Start Date:</h4>
          <p>
            <span>{{startDate}}</span>
            <!-- <span id="ds"></span>
            <span id="ms"></span>
            <span id="ys"></span> -->
          </p>

        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndClick'>
          <h4>End Date:</h4>
          <p>
            <span>{{endDate}}</span>
            <!-- <span id="de"></span>
            <span id="me"></span>
            <span id="ye"></span> -->
          </p>


        </paper-item-body>


      </paper-item>
      </hr>
      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartTimeClick'>
          <h4>Start Time:</h4>
          <p>
            <span>{{startTime}}</span>

          </p>

        </paper-item-body>

      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndTimeClick'>
          <h4>End Time:</h4>
          <p>
            <span>{{endTime}}</span>

          </p>

        </paper-item-body>

      </paper-item>




    </paper-material>

    <paper-material elevation="1">
      <paper-item>

        <paper-item-body class="paper-item-body-1">

          <paper-input-container>
            <label>Slot Duration</label>
            <input is="iron-input" name="duration" type="number" value="{{duration::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-1">
          <paper-input-container>
            <label>Break Duration</label>
            <input is="iron-input" name="break" type="number" value="{{break::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>


      <div id="button">
        <div id="button-create">
          <paper-button id='setTime' raised on-click='createSlots'>Create Time Slots</paper-button>
        </div>
      </div>


    </paper-material>

    <paper-dialog id="startDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateStartPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setStart">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="endDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateEndPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setEnd">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="startTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-time-picker id="timeStartPicker"></paper-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setStartTime">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="endTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-time-picker id="timeEndPicker"></paper-time-picker>


      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setEndTime"> OK</paper-button>

      </div>

    </paper-dialog>
    <paper-dialog id="editDocentDialog" modal role="dialog" exit-animation="fade-out-animation">
      <template is="dom-repeat" items="{{docentList}}">

        <paper-item>

          <paper-item-body class="paper-item-body-0">

            <paper-button id="docentbutton" flat dialog-confirm on-click="pickDocent">
              <span>{{item.firstName}}</span>
              <span>{{item.lastName}}</span>
            </paper-button>

          </paper-item-body>

        </paper-item>


      </template>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>

      </div>
    </paper-dialog>


  </template>


  <script>
    (function() {

      Polymer({
        is: 'create-time',
        properties: {

          checkedMonday: {
            type: Boolean,
            observer: '_mondayChanged'
          },
          checkedTuesday: {
            type: Boolean,
            observer: '_tuesdayChanged'
          },
          checkedWednesday: {
            type: Boolean,
            observer: '_wednesdayChanged'
          },
          checkedThursday: {
            type: Boolean,
            observer: '_thursdayChanged'
          },
          checkedFriday: {
            type: Boolean,
            observer: '_fridayChanged'
          },
          checkedSaturday: {
            type: Boolean,
            observer: '_saturdayChanged'
          },
          docentList: {
            type: Array,
          },
          startDate: {
            Type: Date,
            notify: true
          },
          endDate: {
            Type: Date,
            notify: true
          },
          startTime: {
            Type: Number,
            notify: true
          },
          endTime: {
            Type: Number,
            notify: true
          },
          docentname: {
            type: String,
            notify: true
          },
          selectedDocent: {
            type: Object
          },
          break: {
            type: Number,
            notify: true,
            value: 5
          },
          duration: {
            type: Number,
            notify: true,
            value: 10
          }


        },

        _mondayChanged: function(newValue, oldValue) {
          this.mondayChecked = !this.mondayChecked;
          console.log("changed", this.mondayChecked);
        },
        _tuesdayChanged: function(newValue, oldValue) {
          this.tuesdayChecked = !this.tuesdayChecked;

        },
        _wednesdayChanged: function(newValue, oldValue) {
          this.wednesdayChecked = !this.wednesdayChecked;
          console.log("changed", this.wednesdayChecked);
        },
        _thursdayChanged: function(newValue, oldValue) {
          this.thursdayChecked = !this.thursdayChecked;
        },
        _fridayChanged: function(newValue, oldValue) {
          this.fridayChecked = !this.fridayChecked;
        },
        _saturdayChanged: function(newValue, oldValue) {
          this.saturdayChecked = !this.saturdayChecked;
        },
        ready: function() {

          var self = this;
          var startWeekday, origEndTime, origStartTime;
          var DocentQuery = Parse.Object.extend("Docent");
          var query = new Parse.Query(DocentQuery);
          var clicker;
          var List1 = [];
          var email;
          query.find().then(function(results) {


            for (i in results) {
              var docent = {};
              var object = results[i];
              var docentName = object.get("lastName") + " " + object.get('firstName');
              docent['firstName'] = object.get('firstName');
              docent['lastName'] = object.get('lastName');
              docent['email'] = object.get('email');
              List1.push(docent);
              console.log(docentName);
            }
            console.log("liste", List1);
            self.docentList = List1;
          });


        },
        editButton: function(e) {

          clicker = e.model;
          this.$.editDocentDialog.toggle();

        },
        pickDocent: function(e) {
          var self = this;
          var model = e.model;
          console.log(model.get("item.lastName"));
          // console.log("jo", model);
          var DocentQuery = Parse.Object.extend("Docent");
          var query = new Parse.Query(DocentQuery);
          query.first({
            success: function(user) {
              self.docentname = model.get("item.firstName") + " " + model.get("item.lastName");
              email = model.get("item.email");
              self.selectedDocent = user;
            }
          });
        },

        handleStartClick: function() {
          this.$.startDialog.toggle();
        },
        handleEndClick: function() {
          this.$.endDialog.toggle();
        },
        handleStartTimeClick: function() {
          this.$.startTimeDialog.toggle();
        },
        handleEndTimeClick: function() {
          this.$.endTimeDialog.toggle();
        },
        setStart: function(e) {
          if (this.$.dateStartPicker.date != undefined) {
            var date = this.$.dateStartPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          startWeekday = date.substring(0, 4);
          console.log(startWeekday);
          var formattedDate = date.substring(4, date.length);
          this.startDate = formattedDate;

        },
        setEnd: function() {
          if (this.$.dateEndPicker.date != undefined) {
            var date = this.$.dateEndPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          var formattedDate = date.substring(4, date.length);
          this.endDate = formattedDate;

        },

        setStartTime: function() {

          origStartTime = this.$.timeStartPicker.time;
          var all = origStartTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origStartTime.substring(origStartTime.length - 2, origStartTime.length);
          if (getAMPM === "PM") {
          var hours = hours + 12;
            if (hours === 24) {
              hours = 0;
            }

          }

          this.startTime = hours + ":" + minutes;


        },
        setEndTime: function() {
          origEndTime = this.$.timeEndPicker.time;
          var all = origEndTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origEndTime.substring(origEndTime.length - 2, origEndTime.length);
          if (getAMPM === "PM") {
            var hours = hours + 12;
            if (hours === 24) {
              hours = 0;
            }

          }

          this.endTime = hours + ":" + minutes;
        },

        createSlots: function(e) {

          //variables for time
          var origStartTime = this.$.timeStartPicker.time;
          var origEndTime = this.$.timeEndPicker.time;
          var startTime = moment(origStartTime);
          var endTime = moment(origEndTime);
          var breakTime = this.break;
          var duration = this.duration;
          var partTime = breakTime*1 + duration*1;
          var allStart = origStartTime.split(":");
          var allEnd = origEndTime.split(":");
          var hoursStart = parseInt(allStart[0]);
          var minutesStart = allStart[1].substring(0, allStart[1].length - 2);
          var hoursEnd = parseInt(allEnd[0]);
          var minutesEnd = allEnd[1].substring(0, allEnd[1].length - 2);

          var getAMPMStart = origStartTime.substring(origStartTime.length - 2, origStartTime.length);
          if (getAMPMStart === "PM" ) {
              hoursStart = hoursStart + 12;
              if(hoursStart===24){
              hoursStart = 0;
           }
          }


          var getAMPMEnd = origEndTime.substring(origEndTime.length - 2, origEndTime.length);
          if (getAMPMEnd === "PM") {
            hoursEnd = hoursEnd + 12;
            if (hoursEnd === 24) {
              hoursEnd = 0;
            }
          }
          if (duration < 9 ) {
            var t1 = new Hour("00:0" + duration.toString());
          }
          if (duration > 9 ) {
            var t1 = new Hour("00:" + duration.toString());
          }
          if (breakTime < 9 ) {
            var t2 = new Hour("00:0" + breakTime.toString());
          }
          if (breakTime > 9 ) {
            var t2 = new Hour("00:" + breakTime.toString());
          }
          if (minutesStart < 9 ) {
            var start = new Hour(hoursStart + ":0" + minutesStart);
          }
          if (minutesStart > 9 ) {
            var start = new Hour(hoursStart + ":" + minutesStart);
          }
          var part = t1.add(t2);

          if(hoursStart >= hoursEnd){
            if(hoursStart===hoursEnd){
              if(minutesStart>=minutesEnd){
                alert("Bitte Zeitangaben korrigieren");
                return;
              }
            }
            if(hoursStart>hoursEnd){
              alert("Bitte Zeitangaben korrigieren");
              return;
            }
          }

          var timeDiffer = (60 * hoursEnd + minutesEnd * 1) - (60 * hoursStart + minutesStart * 1);

          var timeArray = new Array(parseInt(timeDiffer / partTime));
          if(partTime>timeDiffer){
            alert("Bitte Zeitslots anpassen");
            return;
          }

          for (var i = 0; i < timeArray.length; i++) {
            timeArray[i] = {
              startTime: start.toString(),
              endTime: (start.add(t1)).toString(),
              availability: "true"
            }

            start = start.add(part);
          }

          //variables for date
          var startDate = new Date(this.startDate);
          var startDate2 = new Date(this.startDate);
          var startDate3 = new Date(this.startDate);
          var startDate4 = new Date(this.startDate);
          var startDate5 = new Date(this.startDate);
          var startDate6 = new Date(this.startDate);
          var endDate = new Date(this.endDate);
          var monday = !this.mondayChecked;
          var tuesday = !this.tuesdayChecked;
          var wednesday = !this.wednesdayChecked;
          var thursday = !this.thursdayChecked;
          var friday = !this.fridayChecked;
          var saturday = !this.saturdayChecked;

          var dateArray = [],
            dateArray2 = [],
            dateArray3 = [],
            dateArray4 = [],
            dateArray5 = [],
            dateArray6 = [];

        if (startDate <= endDate) {

            console.log("3",timeArray);
            var startWeekday;
            // Determine the Start date
            if (monday) {
              if (startDate.is().monday()) {
                var date1 = new Date(startDate.toShortDateString());
                dateArray.push(date1);
              }
              while (startDate.next().monday() <= endDate) {
                var date2 = new Date(startDate.toShortDateString());
                dateArray.push(date2);
              }

            }
            if (tuesday) {
              if (startDate2.is().tuesday()) {
                var date3 = new Date(startDate2.toShortDateString());
                dateArray2.push(date3);
              }

              while (startDate2.next().tuesday() <= endDate) {
                var date4 = new Date(startDate2.toShortDateString());
                dateArray2.push(date4);
              }
            }
            if (wednesday) {
              if (startDate3.is().wednesday()) {
                var date5 = new Date(startDate3.toShortDateString());
                dateArray3.push(date5);
              }

              while (startDate3.next().wednesday() <= endDate) {
                var date6 = new Date(startDate3.toShortDateString());
                dateArray3.push(date6);
              }
            }
            if (thursday) {
              if (startDate4.is().thursday()) {
                var date7 = new Date(startDate4.toShortDateString());
                dateArray4.push(date7);
              }

              while (startDate4.next().thursday() <= endDate) {
                var date8 = new Date(startDate4.toShortDateString());
                dateArray4.push(date8);
              }

            }
            if (friday) {
              if (startDate5.is().friday()) {
                var date9 = new Date(startDate5.toShortDateString());
                dateArray5.push(date9);
              }

              while (startDate5.next().friday() <= endDate) {
                var date10 = new Date(startDate5.toShortDateString());
                dateArray5.push(date10);
              }
            }
            if (saturday) {
              if (startDate6.is().saturday()) {
                var date11 = new Date(startDate6.toShortDateString());
                dateArray5.push(date11);
              }

              while (startDate6.next().saturday() <= endDate) {
                var date12 = new Date(startDate6.toShortDateString());
                dateArray6.push(date12);
              }
            }


            var date_sort = function(date1, date2) {
              if (date1 > date2) return 1;
              if (date1 < date2) return -1;
              return 0;
            }


            var completeDateArray = dateArray.concat(dateArray2, dateArray3, dateArray4, dateArray5, dateArray6);

            completeDateArray.sort(date_sort);



            var DocentQuery = Parse.Object.extend("Docent");
            var query = new Parse.Query(DocentQuery);
            query.equalTo("email", email);
            query.first({
              success: function(user) {

                for (var i = 0; i < completeDateArray.length; i++) {

                  var Slots = Parse.Object.extend("Slots");
                  var slotQuery = new Slots();
                  slotQuery.set("Docent", user);
                  slotQuery.set("dates", moment(completeDateArray[i]));
                  console.log(completeDateArray[i].toString());
                  slotQuery.set("Slots", timeArray);
                  console.log("warum=",timeArray[i]);
                  slotQuery.save();
                }

              }
            });
          //  console.log("timeArray",timeArray);




            /*  var newStartDate = startDate;
              if (startWeekday != undefined) {
                while (newStartDate.day() != startWeekday) {
                  newStartDate.add(1, 'days');

                }
                console.log("start", newStartDate);
              }

              var endWeekday;
              var selected = [];
              if (monday) {
                endWeekday = 1;
                var item = {};
                item["day"] = endWeekday;
                selected.push(item);
              }
              if (tuesday) {
                endWeekday = 2;
                var item = {};
                item["day"] = endWeekday;
                selected.push(item);
              }
              if (wednesday) {
                endWeekday = 3;
                var item = {};
                item["day"] = 3;
                selected.push(item);
              }
              if (thursday) {
                endWeekday = 4;
                var item = {};
                item["day"] = endWeekday;
                selected.push(item);
              }
              if (friday) {
                friday = 5;
                var item = {};
                item["day"] = endWeekday;
                selected.push(item);
              }
              if (saturday) {
                endWeekday = 6;
                var item = {};
                item["day"] = endWeekday;
                selected.push(item);
              }

              var newEndDate = endDate;
              if (endWeekday != undefined) {
                while (newEndDate.day() != endWeekday) {
                  newEndDate.subtract(1, 'days');

                }
                console.log("end", newStartDate);

              }
              // console.log("diff", newStartDate.diff(newEndDate, 'days'));
              // console.log("da",startDate.day(2));
              var dateArr = [];
              console.log(newStartDate.day());
              console.log("startWeekday",startWeekday);
              if(selected.length === 1){
                var day = selected[0].day;
                var t = newStartDate;
                var diff = newStartDate.diff(newEndDate, 'weeks') * -1;
                for (var i = -1; i < diff; i++) {
                    var day = [];
                    var date = t;
                    day[date] = t;
                    dateArr.push(day);
                    t.add(7, "days");
                  }
              }
              console.log(dateArr);*/

            // if (monday) {
            //   var mondayStart = newStartDate;
            // var diff = newStartDate.diff(newEndDate, 'weeks') * -1;
            //   console.log(diff);
            //
            //   for (var i = -1; i < diff; i++) {
            //     var day = [];
            //     var date = mondayStart;
            //     day[date] = mondayStart;
            //     dateArr.push(day);
            //     mondayStart.add(7, "days");
            //   }
            // }


         } else {
            alert("Startdate needs to be before the Enddate");
         }

        }
      });
    })();
  </script>
</dom-module>
