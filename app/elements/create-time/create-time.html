<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../../bower_components/moment/moment.js"></script>
<dom-module id="create-time">
  <style>
    :host {
      display: block;
    }

    paper-button {
      margin-bottom: 24px;
      width: 15%;
    }

    paper-material {
      padding-bottom: 10px;
      padding-top: 10px;
    }

    paper-item-body.paper-item-body-1 {
      width: 50%;
    }

    paper-item-body.paper-item-body-0 [secondary] {
      color: #757575;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
      ;
    }

    .spacer {
      padding-top: 10px;
      border-bottom: 1px solid gray;
    }

    label.prev {
      padding-left: 20px;
      color: #727272;
      position: relative;
      top: 10px;
    }

    #button {
      padding-bottom: 20px;
      width: 100%
    }
    /*paper-button {
      width: 30%;
      display: block;
      margin-top: 30px;
      margin-left: auto;
      margin-right: auto;
    }*/

    #checkboxes {
      width: 100%;
      text-align: center;
    }

    paper-checkbox {
      padding-left: 2%;
    }
  </style>
  <template>

    <paper-material elevation="1">




      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click=''>
          <h4>Pick the days:</h4>
          <div class="checkboxes">

            <paper-checkbox name="monday" checked="{{checkedMonday}}" id="monday">Monday</paper-checkbox>
            <paper-checkbox name="tuesday" checked="{{checkedTuesday}}" id="tuesday">Tuesday</paper-checkbox>
            <paper-checkbox name="wednesday" checked="{{checkedWednesday}}" id="wednesday">Wednesday</paper-checkbox>
            <paper-checkbox name="thursday" checked="{{checkedThursday}}" id="thursday">Thursday</paper-checkbox>
            <paper-checkbox name="friday" checked="{{checkedFriday}}" id="friday">Friday</paper-checkbox>
            <paper-checkbox name="saturday" checked="{{checkedSaturday}}" id="saturday">Saturday</paper-checkbox>
          </div>


        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" flat on-click="editButton">

          <h4>Choose Docent: </h4>
          <p>
            <span>{{docentname}}</span>
          </p>
        </paper-item-body>

      </paper-item>




      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartClick'>
          <h4>Start Date:</h4>
          <p>
            <span>{{startDate}}</span>
            <!-- <span id="ds"></span>
            <span id="ms"></span>
            <span id="ys"></span> -->
          </p>

        </paper-item-body>

      </paper-item>


      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndClick'>
          <h4>End Date:</h4>
          <p>
            <span>{{endDate}}</span>
            <!-- <span id="de"></span>
            <span id="me"></span>
            <span id="ye"></span> -->
          </p>


        </paper-item-body>


      </paper-item>
      </hr>
      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleStartTimeClick'>
          <h4>Start Time:</h4>
          <p>
            <span>{{startTime}}</span>

          </p>

        </paper-item-body>

      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-0" on-click='handleEndTimeClick'>
          <h4>End Time:</h4>
          <p>
            <span>{{endTime}}</span>

          </p>

        </paper-item-body>

      </paper-item>




    </paper-material>

    <paper-material elevation="1">
      <paper-item>

        <paper-item-body class="paper-item-body-1">

          <paper-input-container>
            <label>Slot Duration</label>
            <input is="iron-input" name="duration" type="number" value="{{duration::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>

      <paper-item>
        <paper-item-body class="paper-item-body-1">
          <paper-input-container>
            <label>Break Duration</label>
            <input is="iron-input" name="break" type="number" value="{{break::input}}" required>
          </paper-input-container>
        </paper-item-body>
        <span>minutes.</span>
      </paper-item>


      <div id="button">
        <div id="button-create">
          <paper-button id='setTime' raised on-click='createSlots'>Create Time Slots</paper-button>
        </div>
      </div>


    </paper-material>

    <paper-dialog id="startDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateStartPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setStart">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="endDialog" modal class="paper-date-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-date-picker locale='de-DE' id="dateEndPicker"></paper-date-picker>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="setEnd">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="startTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-time-picker id="timeStartPicker"></paper-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setStartTime">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="endTimeDialog" modal class="paper-time-picker-dialog" role="dialog" exit-animation="fade-out-animation">
      <paper-time-picker id="timeEndPicker"></paper-time-picker>


      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="setEndTime"> OK</paper-button>

      </div>

    </paper-dialog>
    <paper-dialog id="editDocentDialog" modal role="dialog" exit-animation="fade-out-animation">
      <template is="dom-repeat" items="{{docentList}}">

        <paper-item>

          <paper-item-body class="paper-item-body-0">

            <paper-button id="docentbutton" flat dialog-confirm on-click="pickDocent">
              <span>{{item.firstName}}</span>
              <span>{{item.lastName}}</span>
            </paper-button>

          </paper-item-body>

        </paper-item>


      </template>
      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>

      </div>
    </paper-dialog>


  </template>


  <script>
    (function() {

      Polymer({
        is: 'create-time',
        properties: {

          checkedMonday: {
            type: Boolean,
            observer: '_mondayChanged'
          },
          checkedTuesday: {
            type: Boolean,
            observer: '_tuesdayChanged'
          },
          checkedWednesday: {
            type: Boolean,
            observer: '_wednesdayChanged'
          },
          checkedThursday: {
            type: Boolean,
            observer: '_thursdayChanged'
          },
          checkedFriday: {
            type: Boolean,
            observer: '_fridayChanged'
          },
          checkedSaturday: {
            type: Boolean,
            observer: '_saturdayChanged'
          },
          docentList: {
            type: Array,
          },
          startDate: {
            Type: Date,
            notify: true
          },
          endDate: {
            Type: Date,
            notify: true
          },
          startTime: {
            Type: Number,
            notify: true
          },
          endTime: {
            Type: Number,
            notify: true
          },
          docentname: {
            type: String,
            notify: true
          },
          selectedDocent: {
            type: Object
          },
          break: {
            type: Number,
            notify: true,
            value: 5
          },
          duration: {
            type: Number,
            notify: true,
            value: 10
          }


        },

        _mondayChanged: function(newValue, oldValue) {
          this.mondayChecked = !this.mondayChecked;
          console.log("changed", this.mondayChecked);
        },
        _tuesdayChanged: function(newValue, oldValue) {
          this.tuesdayChecked = !this.tuesdayChecked;

        },
        _wednesdayChanged: function(newValue, oldValue) {
          this.wednesdayChecked = !this.wednesdayChecked;
          console.log("changed", this.wednesdayChecked);
        },
        _thursdayChanged: function(newValue, oldValue) {
          this.thursdayChecked = !this.thursdayChecked;
        },
        _fridayChanged: function(newValue, oldValue) {
          this.fridayChecked = !this.fridayChecked;
        },
        _saturdayChanged: function(newValue, oldValue) {
          this.saturdayChecked = !this.saturdayChecked;
        },
        ready: function() {

          var self = this;
          var startWeekday, origEndTime, origStartTime;
          var DocentQuery = Parse.Object.extend("Docent");
          var query = new Parse.Query(DocentQuery);
          var clicker;
          var List1 = [];
          var email;
          query.find().then(function(results) {


            for (i in results) {
              var docent = {};
              var object = results[i];
              var docentName = object.get("lastName") + " " + object.get('firstName');
              docent['firstName'] = object.get('firstName');
              docent['lastName'] = object.get('lastName');
              docent['email'] = object.get('email');
              List1.push(docent);
              console.log(docentName);
            }
            console.log("liste", List1);
            self.docentList = List1;
          });


        },
        editButton: function(e) {

          clicker = e.model;
          this.$.editDocentDialog.toggle();

        },
        pickDocent: function(e) {
          var self = this;
          var model = e.model;
          console.log(model.get("item.lastName"));
          // console.log("jo", model);
          var DocentQuery = Parse.Object.extend("Docent");
          var query = new Parse.Query(DocentQuery);
          query.first({
            success: function(user) {
              self.docentname = model.get("item.firstName") + " " + model.get("item.lastName");
              email = model.get("item.email");
              self.selectedDocent = user;
              console.log(self.selectedDocent);
            }
          });
        },

        handleStartClick: function() {
          this.$.startDialog.toggle();
        },
        handleEndClick: function() {
          this.$.endDialog.toggle();
        },
        handleStartTimeClick: function() {
          this.$.startTimeDialog.toggle();
        },
        handleEndTimeClick: function() {
          this.$.endTimeDialog.toggle();
        },
        setStart: function(e) {
          if (this.$.dateStartPicker.date != undefined) {
            var date = this.$.dateStartPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          startWeekday = date.substring(0, 4);
          console.log(startWeekday);
          var formattedDate = date.substring(4, date.length);
          this.startDate = formattedDate;

        },
        setEnd: function() {
          if (this.$.dateEndPicker.date != undefined) {
            var date = this.$.dateEndPicker.date.toDateString();

          } else {
            var date = new Date();
            date = date.toDateString();
          }
          var formattedDate = date.substring(4, date.length);
          this.endDate = formattedDate;

        },

        setStartTime: function() {

          origStartTime = this.$.timeStartPicker.time;
          var all = origStartTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origStartTime.substring(origStartTime.length - 2, origStartTime.length);
          if (getAMPM === "PM") {
            var hours = hours + 12;
          }

          this.startTime = hours + ":" + minutes;


        },
        setEndTime: function() {
          origEndTime = this.$.timeEndPicker.time;
          var all = origEndTime.split(":");

          var hours = parseInt(all[0]);
          var minutes = all[1].substring(0, all[1].length - 2);

          var getAMPM = origEndTime.substring(origEndTime.length - 2, origEndTime.length);
          if (getAMPM === "PM") {
            var hours = hours + 12;
          }

          this.endTime = hours + ":" + minutes;
        },

        createSlots: function(e) {

          var startDate = moment(new Date(this.startDate));
          var endDate = moment(new Date(this.endDate));
          var startTime = moment(this.origStartTime);
          var endTime = moment(this.origEndTime);
          var breakTime = this.break;
          var duration = this.duration;
          var monday = !this.mondayChecked;
          var tuesday = !this.tuesdayChecked;
          var wednesday = !this.wednesdayChecked;
          var thursday = !this.thursdayChecked;
          var friday = !this.fridayChecked;
          var saturday = !this.saturdayChecked;

          var weekDay = 1;

          if(startDate.isBefore(endDate)){


          var startWeekday;
          // Determine the Start date
          if (monday) {
            startWeekday = 1;
          } else if (tuesday) {
            startWeekday = 2;
          } else if (wednesday) {
            startWeekday = 3;
          } else if (thursday) {
            startWeekday = 4;
          } else if (friday) {
            startWeekday = 5;
          } else if (saturday) {
            startWeekday = 6;
          }
          var newStartDate = startDate;
          if (startWeekday != undefined) {
            while (newStartDate.day() != startWeekday) {
              newStartDate.add(1, 'days');

            }
            console.log("start", newStartDate);
          }

          var endWeekday;
          var selected = [];
          if (monday) {
            endWeekday = 1;
            var item = {};
            item["day"] = endWeekday;
            selected.push(item);
          }
          if (tuesday) {
            endWeekday = 2;
            var item = {};
            item["day"] = endWeekday;
            selected.push(item);
          }
          if (wednesday) {
            endWeekday = 3;
            var item = {};
            item["day"] = 3;
            selected.push(item);
          }
          if (thursday) {
            endWeekday = 4;
            var item = {};
            item["day"] = endWeekday;
            selected.push(item);
          }
          if (friday) {
            friday = 5;
            var item = {};
            item["day"] = endWeekday;
            selected.push(item);
          }
          if (saturday) {
            endWeekday = 6;
            var item = {};
            item["day"] = endWeekday;
            selected.push(item);
          }

          var newEndDate = endDate;
          if (endWeekday != undefined) {
            while (newEndDate.day() != endWeekday) {
              newEndDate.subtract(1, 'days');

            }
            console.log("end", newStartDate);

          }
          // console.log("diff", newStartDate.diff(newEndDate, 'days'));
          // console.log("da",startDate.day(2));
          var dateArr = [];
          console.log(newStartDate.day());
          console.log("startWeekday",startWeekday);
          if(selected.length === 1){
            var day = selected[0].day;
            var t = newStartDate;
            var diff = newStartDate.diff(newEndDate, 'weeks') * -1;
            for (var i = -1; i < diff; i++) {
                var day = [];
                var date = t;
                day[date] = t;
                dateArr.push(day);
                t.add(7, "days");
              }
          }
          console.log(dateArr);

          // if (monday) {
          //   var mondayStart = newStartDate;
            // var diff = newStartDate.diff(newEndDate, 'weeks') * -1;
          //   console.log(diff);
          //
          //   for (var i = -1; i < diff; i++) {
          //     var day = [];
          //     var date = mondayStart;
          //     day[date] = mondayStart;
          //     dateArr.push(day);
          //     mondayStart.add(7, "days");
          //   }
          // }


          }else{
          alert("Startdate needs to be before the Enddate");
          }

        }
      });
    })();
  </script>
</dom-module>
