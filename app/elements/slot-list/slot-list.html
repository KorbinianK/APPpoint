<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="slot-list">
  <style>
    :host {
      display: block;
    }

    paper-card {
      width: 100%;
      position: relative;
    }

    paper-button {
      float: left;
      padding-top: 10px;
    }

    paper-item.custom-item {
      padding-left: 94px;
      position: relative;
    }
    paper-dialog{
      max-width: 600px;
    }

    .pointer {
      cursor:pointer;
    }
  </style>
  <template>


    <loading-placeholder loading-status="{{loading}}"></loading-placeholder>

    <template is="dom-repeat" items="{{dateList}}" as="list" hidden="{{loading}}">

      <paper-card>

        <div class="card-content">
<!-- <paper-material elevation="1"> -->


          <paper-button on-click="expandSlots">
            <iron-icon id="{{computeID1(list.date)}}" icon="{{icon}}"></iron-icon>

          </paper-button>
          <h4>{{list.date}}</h4>

          <iron-collapse id="{{getID(list.date)}}">

            <template is="dom-repeat" items="{{list.slots}}" as="slot">

              <span hidden="true">{{list.date}}</span>
              <paper-item class="custom-item" on-click="slotClicked">
                <paper-item-body three-line class="pointer paper-item-body-0">
                  <paper-ripple hidden={{!slot.availability}} fit></paper-ripple>

                  <div hidden="{{!slot.availability}}">
                    <b class="green">Available</b>
                  </div>

                  <div hidden="{{slot.availability}}">
                    <span class="red">Not available</span>

                  </div>

                  <div secondary><b>From:</b>
                    <span>{{slot.startTime}}</span>
                  </div>
                  <div secondary><b>Until:</b>
                    <span>{{slot.endTime}}</span>
                  </div>
                </paper-item-body>
              </paper-item>


            </template>
          </iron-collapse>
          </paper-material>
        </div>
      </paper-card>
    </template>
    <paper-dialog id="confirmDialog" modal>

      <paper-toolbar>
        <div>
          <h2>Please confirm</h2>
        </div>
      </paper-toolbar>
      </paper-header-panel>



      <paper-item>
        <paper-item-body three-line class="paper-item-body-0">
          <div>
            <h3>{{docent}}</h3>
            <p>Do you want to reserve this slot?</p>

          </div>
          <div secondary><b>Date:</b>
            <span>{{date}}</span>
          </div>
          <div secondary><b>From:</b>
            <span>{{startTime}}</span>
          </div>
          <div secondary><b>Until:</b>
            <span>{{endTime}}</span>
          </div>
        </paper-item-body>
      </paper-item>


      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="confirmClick">Confirm</paper-button>
      </div>
    </paper-dialog>


  </template>
  <script>
    (function() {
      Polymer({
        is: 'slot-list',

        properties: {
          currUser: {
            type: Object
          },
          currentUser: String,
          clickedDocent: {
            type: Object,
            observer: 'clickedDocentChanged'
          },
          loading: {
            type: Boolean,
            value: false,
            notify:true
          },
          icon: {
            type: String,
            value: "expand-more",
            notify: true
          },
          toggle: {
            type: Boolean,
            value: false,
            notify: true
          },
          dateList: {
            type: Array,
            //  observer: 'dateListChanged'
          },
        },
        test: function() {
          document.querySelector('#test').toggle();
        },
        getID: function(date) {
          var doc = this.clickedDocent.get("firstName").toLowerCase();
          var id = date.substring(0, 3).toLowerCase() + date.substring(5, 7).toLowerCase() + date.substring(8, 11).toLowerCase()
           + date.substring(12, date.length) + doc;
          // console.log(id);
          return id;
        },
        computeID1: function(date) {
            var doc = this.clickedDocent.get("firstName").toLowerCase();
            var id = date.substring(0, 3).toLowerCase() + date.substring(5, 7).toLowerCase() + date.substring(8, 11).toLowerCase()
             + date.substring(12, date.length) + doc + "icon";
          return id;
        },
        clickedDocentChanged: function(oldValue, newValue) {



          var self = this;
              self.loading = !self.loading;
          Parse.Cloud.run('singleDocent', {
            email: this.clickedDocent.get("email")
          }, {
            success: function(result) {
              retrievedDocentId = result;
              console.log("docent", result);
              Parse.Cloud.run('dateList', {
                docent: result
              }, {
                success: function(results) {

                  var List = [];
                  for (i in results) {

                    var item = {};
                    var object = results[i];
                    var slots = object.get('Slots');
                    var date = object.get("date");
                    item["date"] = moment(date).locale('en', {
                      months: [
                        "January", "February", "March", "April", "May", "June", "July",
                        "August", "September", "October", "November", "December"
                      ]
                    }).format("ddd, DD MMM YYYY");
                    item["d"] = moment(date).locale('en', {
                      months: [
                        "January", "February", "March", "April", "May", "June", "July",
                        "August", "September", "October", "November", "December"
                      ]
                    }).format("DD MMM YYYY");
                    item["dateObject"] = date;
                    item["slots"] = slots;
                    item["slots"].date = date;
                    item["toggle"] = false;
                    item["toggleIcon"] = false;
                    List.push(item);
                    // console.log("date",date);
                  }
                  // if(List.length === 0){
                  //     var item = {};
                  //   item["empty"] = "This Docent is currently not available";
                  //       List.push(item);
                  // }
                  objSort(List,"d");
                  self.dateList = List;
                  self.loading = !self.loading;

                },
                error: function(error) {
                  console.log("error");

                }
              });

            },
            error: function(error) {}
          });

        },
        ready: function() {
          var self = this;
          var clickedSlot;
          var retrievedDocentId;
          var fixedDate;
          var queryDate;
          moment.tz.add("Europe/Berlin|CET CEST CEMT|-10 -20 -30|01010101010101210101210101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 1cM0 1cM0 kL0 Nc0 m10 WM0 1ao0 1cp0 dX0 jz0 Dd0 1io0 17c0 1fA0 1a00 1ehA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00");
          moment.tz.setDefault("Europe/Berlin");
        },
        expandSlots: function(e) {
          var model = e.model;
          var date = model.get("list.date");
          var doc = this.clickedDocent.get("firstName").toLowerCase();
          var theID = date.substring(0, 3).toLowerCase() + date.substring(5, 7).toLowerCase() + date.substring(8, 11).toLowerCase() + date.substring(12, date.length) + doc;
          // theID = "#" + theID;


          if (this.querySelector(".iron-collapse-opened") != null) {
            var found = Polymer.dom(this.root).querySelector(".iron-collapse-opened");
            var foundID = $(found).attr('id');

            if (foundID != theID) {
              Polymer.dom(this.root).querySelector(".iron-collapse-opened").toggle();
              var ico = Polymer.dom(this.root).querySelector('#' + foundID + "icon");
              console.log("ico",ico);
              if (ico != undefined) {
                ico.setAttribute("icon", "expand-more");
              }
            }
            this.querySelector('#' + theID).toggle();

          } else {
            console.log(theID);
            this.querySelector('#' + theID).toggle();
          }
          var iconstatus = this.querySelector('#' + theID + "icon");
          iconstatus = iconstatus.getAttribute("icon");
          if (iconstatus === "expand-less") {
            console.log("less");
            this.querySelector('#' + theID + "icon").setAttribute("icon", "expand-more");
          } else {
            console.log("more");
            this.querySelector('#' + theID + "icon").setAttribute("icon", "expand-less");
          }
        },
        dateClicked: function(e) {

        },
        slotClicked: function(e) {
          var model = e.model;
          clickedSlot = model;


          var available = model.get("slot.availability");

          var docentName = this.clickedDocent.get("lastName") + " " + this.clickedDocent.get("firstName");

          this.startTime = model.get("slot.startTime");
          this.endTime = model.get("slot.endTime");
          this.docent = docentName;
          // fixedDate = new moment(new Date(model.get("list.date")));
          this.date = model.get("list.dateObject");
          queryDate = this.date;
          console.log("querydate");
          this.date = moment(this.date).locale('en', {
            months: [
              "January", "February", "March", "April", "May", "June", "July",
              "August", "September", "October", "November", "December"
            ]
          }).format("ddd, DD MMM YYYY");

          if (available) {

            this.currentUser = this.currUser.get("email");
            this.$.confirmDialog.toggle();
          }
        },
        confirmClick: function(e) {
          var self = this;
          var model = e.model;
          var user = Parse.User.current();


          Parse.Cloud.run('createAppointment', {
            docentId: retrievedDocentId,
            userEmail: user.get("email"),
            slotStartTime: this.startTime,
            slotDate: queryDate
          }, {
            success: function(result) {
            clickedSlot.set("slot.availability", false);
              console.log("result",result);
            },
            error: function(error) {}
          });

        }


      });
    })();
  </script>
</dom-module>
