<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<script src="../../../bower_components/moment/moment.js"></script>
<script src="../../bower_components/moment-recur/moment-recur.js"></script>

<dom-module id="slot-list">
  <style>
    :host {
      display: block;
    }

    paper-card {
      width: 100%;
      position: relative;
    }

    paper-button {
      float: left;
      padding-top: 10px;
    }

    paper-item.custom-item {
      padding-left: 94px;
      position: relative;
    }
  </style>
  <template>


    <!-- <loading-placeholder loading-status="{{loading}}"></loading-placeholder> -->

    <template is="dom-repeat" items="{{dateList}}" as="list">

      <paper-card>

        <div class="card-content">

          <paper-button on-click="expandSlots">
            <iron-icon icon="{{icon}}"></iron-icon>

          </paper-button>
          <h3>{{list.date}}</h3>

          <iron-collapse id="{{getID(list.date)}}">
          <!-- <h3>  test</h3>
     -->
          <template is="dom-repeat" items="{{list.slots}}" as="slot">

              <span hidden="true">{{list.date}}</span>
              <paper-item class="custom-item" on-click="slotClicked">
                <paper-item-body three-line class="paper-item-body-0">
                  <paper-ripple fit></paper-ripple>

                  <div hidden="{{!slot.availability}}">
                    <b class="green">Available</b>
                  </div>

                  <div hidden="{{slot.availability}}">
                    <b class="red">Not available</b>

                  </div>

                  <div secondary><b>From:</b>
                    <span>{{slot.startTime}}</span>
                  </div>
                  <div secondary><b>Until:</b>
                    <span>{{slot.endTime}}</span>
                  </div>
                </paper-item-body>
              </paper-item>


            </template>
      </iron-collapse>
      </paper-card>
    </template>
    <paper-dialog id="confirmDialog" modal>

      <paper-toolbar>
        <div>
          <h2>Please confirm</h2>
        </div>
      </paper-toolbar>
      </paper-header-panel>



      <paper-item>
        <paper-item-body three-line class="paper-item-body-0">
          <div>
            <h3>{{docent}}</h3>
            <p>Do you want to reserve this slot?</p>

          </div>
          <div secondary><b>Date:</b>
            <span>{{date}}</span>
          </div>
          <div secondary><b>From:</b>
            <span>{{startTime}}</span>
          </div>
          <div secondary><b>Until:</b>
            <span>{{endTime}}</span>
          </div>
        </paper-item-body>
      </paper-item>


      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="confirmClick">Confirm</paper-button>
      </div>
    </paper-dialog>


  </template>
  <script>
    (function() {
      Polymer({
        is: 'slot-list',

        properties: {
          currUser: {
            type: Object
          },
          currentUser: String,
          clickedDocent: {
            type: Object,
            observer: 'clickedDocentChanged'
          },
          loading: {
            type: Boolean
          },
          icon: {
            type: String,
            value: "expand-more",
            notify: true
          },
          toggle: {
            type: Boolean,
            value: false,
            notify: true
          },
          dateList: {
            type: Array,
            //  observer: 'dateListChanged'
          },
        },
        test: function(){
          document.querySelector('#test').toggle();
        },
        getID: function(date) {
          var id = date.substring(0, 3).toLowerCase() + date.substring(5, 7).toLowerCase() + date.substring(8, 11).toLowerCase() + date.substring(12, date.length);
          console.log(id);
          return id;
        },
        clickedDocentChanged: function(oldValue, newValue) {
          var self = this;
          console.log("change", oldValue, newValue);

          Parse.Cloud.run('singleDocent', {
            email: this.clickedDocent.get("email")
          }, {
            success: function(result) {
              retrievedDocentId = result;
              console.log("docent", result);
              Parse.Cloud.run('dateList', {
                docent: result
              }, {
                success: function(results) {

                  var List = [];
                  for (i in results) {

                    var item = {};
                    var object = results[i];
                    var slots = object.get('Slots');
                    var date = object.get("date");
                    item["date"] = moment(date).locale('en', {
                      months: [
                        "January", "February", "March", "April", "May", "June", "July",
                        "August", "September", "October", "November", "December"
                      ]
                    }).format("ddd, DD MMM YYYY");

                    item["slots"] = slots;
                    item["slots"].date = date;
                    item["toggle"] = false;
                    item["toggleIcon"] = false;
                    List.push(item);
                  }
                  // List.sort();
                  console.log("List", List);
                  self.dateList = List;
                  self.loading = !self.loading;

                },
                error: function(error) {
                  console.log("error");
                }
              });

            },
            error: function(error) {}
          });

        },
        ready: function() {
          var self = this;
          var clickedSlot;
          var retrievedDocentId;
          var fixedDate;
        },
        expandSlots: function(e) {
          var model = e.model;
          var date = model.get("list.date");
          var theID = date.substring(0, 3).toLowerCase() + date.substring(5, 7).toLowerCase() + date.substring(8, 11).toLowerCase() + date.substring(12, date.length);
        theID = "#"+theID;
        console.log(this.querySelector(theID));
        this.querySelector(theID).toggle();
        },
        dateClicked: function(e) {

        },
        slotClicked: function(e) {
          var model = e.model;
          clickedSlot = model.get("slot.startTime");


          var available = model.get("slot.availability");

          var docentName = this.clickedDocent.get("lastName") + " " + this.clickedDocent.get("firstName");

          this.startTime = model.get("slot.startTime");
          this.endTime = model.get("slot.endTime");
          this.docent = docentName;
          fixedDate = new moment(new Date(model.get("list.date")));
          this.date = model.get("list.date");
          // console.log("slot", model);
          // console.log(fixedDate);
          if (available) {
            model.set("slot.availability", false);
            this.currentUser = this.currUser.get("email");
            this.$.confirmDialog.toggle();
          } else {
            model.set("slot.availability", true);
          }
        },
        confirmClick: function(e) {
          var model = e.model;
          var user = Parse.User.current();
          console.log(user.get("email"));
          Parse.Cloud.run('createAppointment', {
            docentId: retrievedDocentId,
            userEmail: user.get("email"),
            slotStartTime: this.startTime,
            slotDate: fixedDate,
          }, {
            success: function(result) {
              console.log("created", result);
              // clickedRoom.set("item.status", false);
              // clickedRoom.set("item.email", result.get("email"));
              // clickedRoom.set("item.docent", result.get("lastName") + " " + result.get("firstName"));
              // clickedRoom.set("item.docentObject", result);

            },
            error: function(error) {}
          });

        }


      });
    })();
  </script>
</dom-module>
