<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="slot-list">
  <style>
    :host {
      display: block;
    }

    paper-card {
      width: 100%;
    }
paper-button {
  float:left;
  padding-top: 10px;
}

    paper-item.custom-item{
      padding-left: 94px;
    }
  </style>
  <template>

<!-- <span>{{currUser}}</span><span>{{clickedDocent}}</span> -->
    <loading-placeholder loading-status="{{loading}}"></loading-placeholder>

    <template is="dom-repeat" items="{{dateList}}" as="list">
      <paper-card id="{{list.date}}">

        <div class="card-content" >
          <!-- <paper-ripple fit></paper-ripple> -->
          <paper-button on-tap="toggleSlots">
            <iron-icon icon="{{icon}}"></iron-icon>

          </paper-button>
          <h3>{{list.date}}</h3>

          <template is="dom-repeat" items="{{list.slots}}" as="slot" >

            <paper-item id="{{slot.startTime}}" class="custom-item" hidden="{{!toggle}}" on-click="slotClicked">
              <paper-item-body three-line class="paper-item-body-0">
                <div hidden="{{!slot.availability}}">
                  <b class="green">Available</b>

                </div>
                <div hidden="{{slot.availability}}">
                  <b class="red">Not available</b>

                </div>
                <div secondary><b>From:</b>
                  <span>{{slot.startTime}}</span>
                </div>
                <div secondary><b>Until:</b>
                  <span>{{slot.endTime}}</span>
                </div>
              </paper-item-body>
            </paper-item>


          </template>

      </paper-card>
    </template>
    <paper-dialog id="confirmDialog" modal>

      <paper-header-panel>
        <paper-toolbar>
          <div>
            <h2>Please confirm</h2>
          </div>
        </paper-toolbar>
      </paper-header-panel>



      <paper-item >
        <paper-item-body three-line class="paper-item-body-0">
          <div>
            <h3>{{docent}}</h3>
            <p>Do you want to reserve this slot?</p>

          </div>

          <div secondary><b>From:</b>
            <span>{{startTime}}</span>
          </div>
          <div secondary><b>Until:</b>
            <span>{{endTime}}</span>
          </div>
        </paper-item-body>
      </paper-item>


      <div class="buttons">
        <paper-button flat dialog-dismiss>Cancel</paper-button>
        <paper-button flat dialog-confirm on-click="confirmClick">Confirm</paper-button>
      </div>
    </paper-dialog>


  </template>
  <script>
    (function() {
      Polymer({
        is: 'slot-list',

        properties: {
          currUser:{
            type: Object
          },
          currentUser: String,
          clickedDocent: {
            type: Object,
            observer: 'clickedDocentChanged'
          },
          loading: {
            type: Boolean
          },
          icon: {
            type: String,
            value: "expand-more",
            notify: true
          },
          toggle: {
            type: Boolean,
            value: false
          },
          dateList: {
            type: Array,
            //  observer: 'dateListChanged'
          },
        },

      clickedDocentChanged: function(oldValue, newValue) {
        var self = this;
        console.log("change",oldValue,newValue);

        Parse.Cloud.run('singleDocent', {
          email: this.clickedDocent.get("email")
        }, {
          success: function(result) {
            retrievedDocentId = result;
            console.log("docent", result);
            Parse.Cloud.run('dateList', {
              docent: result
            }, {
              success: function(results) {

                var List = [];
                for (i in results) {

                  var item = {};
                  var object = results[i];
                  var slots = object.get('Slots');
                  var date = object.get("date");
                  date = new Date(date);
                  date = new moment(date);
                  date = date.format("ddd, MMM DD YYYY")
                  console.log(date);
                  item["date"] = date;
                  item["slots"] = slots;
                  item["toggle"] = false;
                  List.push(item);

                }
                List.sort();

                self.dateList = List;
                self.loading = !self.loading;

              },
              error: function(error) {
                console.log("error");
              }
            });

          },
          error: function(error) {}
        });

        },
        ready: function() {
          var self = this;
          var clickedSlot;
          var retrievedDocentId;
        },
        toggleSlots: function(e) {

          var model = e.model;
          // var toggle = model.get("item");
          // console.log("tog",model);
          this.toggle = !this.toggle;
          if (this.toggle) {
            this.icon = "expand-less";
          } else {
            this.icon = "expand-more";
          }

        },
        dateClicked: function(e) {

        },
        slotClicked: function(e) {
            var model = e.model;
            clickedSlot = model.get("slot.startTime");
          function parent(){
            var test = $('#00:00').html();
            console.log("a",test);
          }
          parent();

          console.log("this",e);
          var available = model.get("slot.availability");

          var docentName = this.clickedDocent.get("lastName")+" "+this.clickedDocent.get("firstName");

          this.startTime = model.get("slot.startTime");
          this.endTime = model.get("slot.endTime");
          this.docent = docentName;
          console.log("slot", model);
          if(available){
            model.set("slot.availability",false);
            this.currentUser = this.currUser.get("email");
            this.$.confirmDialog.toggle();
          }else{
            model.set("slot.availability",true);
          }
        },
        confirmClick: function(e){
          var model = e.model;
            var user = Parse.User.current();
          console.log(user.get("email"));
          Parse.Cloud.run('createAppointment', {
            docentId: retrievedDocentId,
            userEmail: user.get("email"),
            slotStartTime: this.startTime,
            // slotDate: ,
          }, {
            success: function(result) {
              console.log("created",result);
              // clickedRoom.set("item.status", false);
              // clickedRoom.set("item.email", result.get("email"));
              // clickedRoom.set("item.docent", result.get("lastName") + " " + result.get("firstName"));
              // clickedRoom.set("item.docentObject", result);

            },
            error: function(error) {}
          });

        }


      });
    })();
  </script>
</dom-module>
